# 设备选择功能说明

## 功能概述

绿视率分析系统现已支持用户自定义选择计算设备，提供更灵活的性能配置选项。

## 新增功能

### 1. 设备选择控件
在GUI界面的"系统配置"组中新增了设备选择下拉框，提供三个选项：
- **自动选择**: 系统智能检测并选择最佳设备（优先GPU，回退CPU）
- **强制使用CPU**: 强制使用CPU进行计算
- **强制使用GPU**: 尝试使用GPU，如不可用则自动回退到CPU

### 2. 设备状态显示
在设备选择控件下方显示当前使用的设备状态：
- 🟢 **GPU可用**: 显示具体GPU型号（如：NVIDIA GeForce RTX 2060 SUPER）
- 🔵 **CPU模式**: 显示"使用CPU模式"
- 🟡 **回退状态**: 当GPU不可用时显示回退信息

### 3. 智能回退机制
系统具备完善的智能回退机制：
- 自动检测CUDA可用性
- GPU设备健康检查
- 失败时自动回退到CPU
- 用户友好的状态提示

## 使用方法

1. **启动程序**: 程序启动时会自动检测并选择最佳设备
2. **切换设备**: 在"系统配置"组中选择所需的设备模式
3. **查看状态**: 通过设备状态标签了解当前使用的设备
4. **加载模型**: 点击"加载模型"按钮应用设备设置

## 技术特性

### 设备检测逻辑
```python
# 自动选择模式
if device == "auto":
    if torch.cuda.is_available():
        # 测试CUDA设备
        try:
            test_tensor = torch.tensor([1.0]).cuda()
            return "cuda"
        except:
            return "cpu"  # 回退到CPU
    else:
        return "cpu"
```

### 智能回退机制
- **CUDA可用性检测**: 使用`torch.cuda.is_available()`
- **设备健康检查**: 创建测试张量验证GPU功能
- **异常处理**: 捕获GPU初始化失败并自动回退
- **内存清理**: 自动清理GPU内存避免冲突

## 性能对比

| 设备类型 | 推理速度 | 内存占用 | 适用场景 |
|---------|---------|---------|---------|
| GPU (CUDA) | 快 | 高 | 大批量处理 |
| CPU | 慢 | 低 | 小批量处理、兼容性 |

## 故障排除

### 常见问题
1. **GPU不可用**: 检查CUDA驱动安装
2. **内存不足**: 选择CPU模式或关闭其他GPU应用
3. **驱动版本**: 确保CUDA版本与PyTorch兼容

### 解决方案
- 使用"强制使用CPU"确保程序正常运行
- 查看设备状态标签获取详细信息
- 重启程序重新检测设备状态

## 更新日志

### v1.2.0 (2024-01-XX)
- ✅ 新增设备选择控件
- ✅ 实现智能回退机制
- ✅ 添加设备状态显示
- ✅ 优化用户体验

---

**注意**: 此功能需要系统安装相应的CUDA驱动才能使用GPU加速。如果没有GPU或驱动问题，系统会自动使用CPU模式，不影响正常使用。